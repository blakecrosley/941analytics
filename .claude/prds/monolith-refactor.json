{
  "project": {
    "name": "Refactor routes.py Monolith",
    "description": "Split the 2,597-line routes.py into maintainable components. This is the foundation for all future dashboard improvements. Currently contains all HTML, CSS, JavaScript embedded in Python - impossible to maintain or extend.",
    "priority": 2,
    "estimated_effort": "2-3 days",
    "created_at": "2026-01-17T18:05:00Z",
    "completed_at": "2026-01-17T21:00:00Z"
  },
  "current_state": {
    "file": "src/analytics_941/routes/dashboard.py",
    "lines": 865,
    "status": "refactored",
    "improvements": [
      "HTML moved to Jinja2 templates (19 files)",
      "CSS extracted to static/css/dashboard.css (636 lines)",
      "JavaScript extracted to static/js/dashboard.js",
      "Routes split into modular structure",
      "Static file serving configured",
      "HTMX partial loading for all tabs"
    ]
  },
  "stories": [
    {
      "id": "refactor-1",
      "title": "Create base template and layout",
      "description": "Extract the base HTML structure into Jinja2 template with proper head, nav, and content blocks.",
      "acceptance_criteria": [
        "base.html with HTML5 doctype and proper meta tags",
        "Navigation component extracted",
        "Content block for page-specific content",
        "CSS and JS properly linked (not inline)",
        "HTMX and Alpine.js loaded from CDN",
        "Dark mode support preserved"
      ],
      "files_created": [
        "src/analytics_941/templates/base.html"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1
    },
    {
      "id": "refactor-2",
      "title": "Extract CSS to static files",
      "description": "Move all inline CSS to separate stylesheet files with proper organization.",
      "acceptance_criteria": [
        "dashboard.css contains all main dashboard styles",
        "CSS custom properties for theming",
        "Mobile-first responsive breakpoints",
        "No inline styles remaining in templates",
        "Styles work with static file serving"
      ],
      "files_created": [
        "src/analytics_941/static/css/dashboard.css"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "notes": "Combined all styles into single dashboard.css (636 lines) - simpler than multiple files"
    },
    {
      "id": "refactor-3",
      "title": "Extract JavaScript to static files",
      "description": "Move all inline JavaScript to separate files with proper module structure.",
      "acceptance_criteria": [
        "dashboard.js contains core interactivity (datePickerComponent)",
        "No inline scripts remaining in templates",
        "HTMX event handlers properly set up",
        "Component reads initial data from data-* attributes"
      ],
      "files_created": [
        "src/analytics_941/static/js/dashboard.js"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "notes": "Globe JS remains in separate track.js (existing). Charts use inline CSS bars for simplicity."
    },
    {
      "id": "refactor-4",
      "title": "Create component templates",
      "description": "Extract reusable UI components into Jinja2 partials.",
      "acceptance_criteria": [
        "stats_cards.html for metric display",
        "chart.html for chart containers",
        "data_table.html for data tables",
        "date_picker.html for filter UI",
        "Components accept parameters via Jinja2 context"
      ],
      "files_created": [
        "src/analytics_941/templates/components/stats_cards.html",
        "src/analytics_941/templates/components/chart.html",
        "src/analytics_941/templates/components/chart_bars.html",
        "src/analytics_941/templates/components/data_table.html",
        "src/analytics_941/templates/components/date_picker.html"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1
    },
    {
      "id": "refactor-5",
      "title": "Create tab content partials",
      "description": "Extract each dashboard tab into its own partial for HTMX loading.",
      "acceptance_criteria": [
        "overview_content.html for main stats view",
        "sources_content.html for traffic sources",
        "geography_content.html for geographic data",
        "technology_content.html for device/browser data",
        "realtime_content.html for live visitors",
        "events_content.html for custom events",
        "Each partial can be loaded independently via HTMX"
      ],
      "files_created": [
        "src/analytics_941/templates/partials/overview_content.html",
        "src/analytics_941/templates/partials/sources_content.html",
        "src/analytics_941/templates/partials/geography_content.html",
        "src/analytics_941/templates/partials/technology_content.html",
        "src/analytics_941/templates/partials/realtime_content.html",
        "src/analytics_941/templates/partials/events_content.html"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1
    },
    {
      "id": "refactor-6",
      "title": "Split routes into modules",
      "description": "Split monolithic routes.py into focused route modules.",
      "acceptance_criteria": [
        "routes/__init__.py exports create_dashboard_router",
        "routes/dashboard.py handles all page rendering",
        "Dashboard reduced from 2,597 to ~865 lines",
        "Original routes.py kept for backward compat"
      ],
      "files_created": [
        "src/analytics_941/routes/__init__.py",
        "src/analytics_941/routes/dashboard.py"
      ],
      "priority": 3,
      "passes": true,
      "attempts": 1,
      "notes": "Auth and API kept in dashboard.py for simplicity - can be split later if needed"
    },
    {
      "id": "refactor-7",
      "title": "Configure static file serving",
      "description": "Set up proper static file serving with caching.",
      "acceptance_criteria": [
        "FastAPI StaticFiles mount for /static/",
        "Static files served from router",
        "CSS and JS loaded from external files",
        "Works with relative URLs for nested mounts"
      ],
      "files_modified": [
        "src/analytics_941/routes/dashboard.py",
        "src/analytics_941/templates/base.html"
      ],
      "priority": 3,
      "passes": true,
      "attempts": 1,
      "notes": "Asset fingerprinting deferred - cache headers sufficient for now"
    }
  ],
  "implementation_notes": [
    "Final structure: 19 template files, 1 CSS file (636 lines), 1 JS file (105 lines)",
    "Dashboard.py reduced from 2,597 to ~865 lines (67% reduction)",
    "All tabs load via HTMX partials for better UX",
    "Static files mounted at /static/ relative to dashboard prefix",
    "Data attributes used to pass server data to Alpine.js components"
  ],
  "verification": {
    "manual_tests": [
      "Dashboard loads and displays data correctly",
      "Tab navigation works via HTMX",
      "Styles render correctly from external CSS",
      "Date picker works with external JS",
      "Responsive design preserved"
    ]
  }
}
