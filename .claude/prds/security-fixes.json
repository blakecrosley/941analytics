{
  "project": {
    "name": "Security Vulnerability Fixes",
    "description": "Address 3 critical security vulnerabilities identified during architecture deliberation. Must be completed before any feature work.",
    "priority": 1,
    "estimated_effort": "2-4 hours",
    "created_at": "2026-01-17T18:05:00Z",
    "completed_at": "2026-01-17T20:30:00Z"
  },
  "stories": [
    {
      "id": "sec-1",
      "title": "Add site validation on Worker /collect endpoint",
      "description": "The /collect endpoint accepts any 'site' parameter without validation. An attacker could inject arbitrary site names into the database, polluting analytics data or using it as a data store.",
      "severity": "high",
      "acceptance_criteria": [
        "Worker maintains allowlist of valid site identifiers via ALLOWED_SITES env var",
        "Requests with invalid site parameter return 400 error",
        "Allowlist is configurable via Worker environment variable",
        "Invalid site attempts are logged with [SECURITY] prefix",
        "Existing valid sites continue working",
        "Test covers invalid site rejection (deferred to cicd-6)"
      ],
      "files_modified": [
        "worker/src/index.ts",
        "worker/wrangler.toml"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1
    },
    {
      "id": "sec-2",
      "title": "Add rate limiting on dashboard login",
      "description": "Dashboard login endpoint has no rate limiting. An attacker could brute force the passkey by trying millions of combinations.",
      "severity": "high",
      "acceptance_criteria": [
        "Rate limit login attempts to 5 per 15 minutes per IP",
        "Use in-memory rate limiter with thread safety",
        "Return 429 Too Many Requests when limit exceeded",
        "Successful login resets counter",
        "Rate limit key uses hashed IP (no raw IPs stored)",
        "Test covers rate limiting behavior (deferred to cicd-6)"
      ],
      "files_modified": [
        "src/analytics_941/routes/dashboard.py"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1
    },
    {
      "id": "sec-3",
      "title": "Hash passkeys with timing-safe comparison",
      "description": "Passkeys are compared in plaintext. This is vulnerable to timing attacks.",
      "severity": "medium",
      "acceptance_criteria": [
        "Passkeys hashed with PBKDF2-SHA256 (100k iterations)",
        "Comparison uses secrets.compare_digest for timing safety",
        "Legacy plaintext passkeys still work (backward compatible)",
        "Migration documented in hash_passkey docstring",
        "Hash salt is unique per passkey (16 random bytes)",
        "Test covers timing-safe comparison (deferred to cicd-6)"
      ],
      "files_modified": [
        "src/analytics_941/config.py",
        "src/analytics_941/routes/dashboard.py"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1
    }
  ],
  "implementation_notes": [
    "Site allowlist: blakecrosley.com, resumegeni.com, 941return.com, 941apps.com, acecitizenship.app, h3arted.com",
    "Rate limiter uses in-memory storage (sufficient for single-instance dashboard)",
    "PBKDF2 used instead of bcrypt to avoid external dependencies",
    "Hash format: pbkdf2:iterations:salt_hex:hash_hex"
  ],
  "verification": {
    "manual_tests": [
      "Attempt to collect with invalid site parameter - returns 400",
      "Attempt 6 failed logins within 15 minutes - returns 429",
      "Verify passkey comparison works with both plaintext and hashed"
    ],
    "automated_tests_pending": [
      "test_invalid_site_rejected",
      "test_rate_limit_enforced",
      "test_passkey_timing_safe"
    ]
  }
}
