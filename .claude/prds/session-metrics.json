{
  "project": {
    "name": "Session Metrics & Engagement",
    "description": "Complete the session tracking implementation. Schema exists in D1 but bounce rate and session duration are not being calculated or displayed. This is critical for understanding engagement quality.",
    "priority": 2,
    "estimated_effort": "1-2 days"
  },
  "stories": [
    {
      "id": "session-1",
      "title": "Session aggregation in Worker",
      "description": "Update the Cloudflare Worker to properly close sessions and calculate duration/bounce status when session times out or new session starts.",
      "acceptance_criteria": [
        "Session closed after 30 minutes of inactivity",
        "Session duration calculated as last_activity - first_pageview",
        "is_bounce = true if pageview_count = 1",
        "Sessions table updated with duration_seconds, is_bounce, exit_page",
        "Heartbeat pings extend session without creating new pageview",
        "Works correctly with multiple tabs open"
      ],
      "files_to_modify": [
        "worker/src/index.ts"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added SESSION_CONFIG (30min timeout). Updated tracking script with client-side session ID generation using sessionStorage (handles multi-tab correctly), heartbeat every 30s, visibility change handling. Added SessionData interface, upsertSession() to create/update sessions, closeExpiredSessions() called by scheduled handler. Heartbeats extend session without creating pageview records. Session duration calculated on closure via scheduled job."
    },
    {
      "id": "session-2",
      "title": "Session metrics client methods",
      "description": "Add client methods to query session metrics from D1 database.",
      "acceptance_criteria": [
        "get_bounce_rate(start, end, filters) returns float 0-100",
        "get_avg_session_duration(start, end, filters) returns seconds",
        "get_sessions_count(start, end, filters) returns int",
        "get_pages_per_session(start, end, filters) returns float",
        "All methods handle zero-data gracefully (return 0, not error)",
        "Comparison period support for trend calculation"
      ],
      "files_to_modify": [
        "src/analytics_941/core/client.py",
        "tests/test_sessions.py"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added 4 standalone session metrics methods to client.py: get_bounce_rate (0-100%), get_avg_session_duration (seconds), get_sessions_count (int), get_pages_per_session (float, 1 decimal). All use _build_session_filter_sql for DashboardFilters support. All handle zero-data gracefully (return 0, not error). All support comparison periods via compare_start/compare_end. 25 unit tests passing in tests/test_sessions.py."
    },
    {
      "id": "session-3",
      "title": "Display session metrics in dashboard",
      "description": "Add bounce rate and avg session duration to the overview stats cards and show session trends.",
      "acceptance_criteria": [
        "Bounce rate stat card with trend arrow",
        "Avg session duration stat card (formatted as Xm Ys)",
        "Pages per session stat card",
        "Session-based chart option (toggle between views/sessions)",
        "Bounce rate shown per page in top pages table",
        "Session metrics respect active filters"
      ],
      "files_to_modify": [
        "src/analytics_941/templates/partials/_overview.html",
        "src/analytics_941/templates/components/_stat_card.html",
        "src/analytics_941/routes/dashboard.py"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added pages_per_session to CoreMetrics model. Updated get_core_metrics() to calculate pages_per_session with comparison period support. Added Pages/Session stat card to stats_cards.html. Added Sessions toggle button to chart.html for HTMX metric switching. Enhanced get_top_pages() to query bounce rates per entry page from sessions table and include bounce_rate in PageStats. Added Bounce column to top pages table in overview_content.html. All metrics respect active filters via _build_session_filter_sql."
    },
    {
      "id": "session-4",
      "title": "Entry/exit page analysis",
      "description": "Show which pages users land on and leave from, helping identify drop-off points.",
      "acceptance_criteria": [
        "Top entry pages table with session count",
        "Top exit pages table with exit rate percentage",
        "Entry → Exit flow visualization (simple, not Sankey)",
        "Bounce rate per entry page",
        "Accessible from overview or dedicated section"
      ],
      "files_to_modify": [
        "src/analytics_941/templates/partials/_overview.html",
        "src/analytics_941/core/client.py"
      ],
      "priority": 3,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added exit_rate field to PageStats model. Updated get_entry_pages() to include bounce_rate per entry page. Updated get_exit_pages() to calculate exit_rate (exits/pageviews*100) with separate pageviews query. Added get_entry_exit_flow() for entry→exit page combinations. Updated dashboard.py routes to fetch entry_pages, exit_pages, entry_exit_flow. Added Entry Pages and Exit Pages tables (grid-2) and Page Flow table to overview_content.html showing top entry→exit combinations. All 105 tests passing."
    }
  ]
}
