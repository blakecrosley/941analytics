{
  "project": {
    "name": "Enhanced Event Tracking",
    "description": "Expand tracking beyond pageviews to capture meaningful user interactions automatically, plus support for custom events. This transforms the analytics from 'traffic counter' to 'behavior insights'.",
    "priority": 3,
    "estimated_effort": "2-3 days"
  },
  "stories": [
    {
      "id": "track-1",
      "title": "Auto-track scroll depth",
      "description": "Automatically track how far users scroll on each page (25%, 50%, 75%, 100% milestones).",
      "acceptance_criteria": [
        "Scroll depth tracked at 25%, 50%, 75%, 100% thresholds",
        "Each threshold fires only once per page",
        "Works with infinite scroll / dynamic content",
        "Debounced to avoid excessive events",
        "Event includes page URL and max depth reached",
        "Dashboard shows avg scroll depth per page"
      ],
      "files_to_modify": [
        "worker/src/track.js",
        "src/analytics_941/templates/partials/_events.html",
        "src/analytics_941/core/client.py"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added /event endpoint to worker for event collection via image beacon. Updated TRACKING_SCRIPT with scroll tracking: scrollDepths state, trackEvent() and trackScroll() functions, 100ms debounce, resets on SPA navigation via resetScrollTracking(). Each threshold fires once per page via scrollDepths[depth] flag. Added get_scroll_depth_by_page() client method. Updated events routes and template with scroll_depth_by_page table showing avg depth per page."
    },
    {
      "id": "track-2",
      "title": "Auto-track outbound clicks",
      "description": "Automatically track clicks on external links leaving your site.",
      "acceptance_criteria": [
        "Outbound link clicks captured with destination URL",
        "Internal links (same domain) ignored",
        "Event fires before navigation (with small delay)",
        "Dashboard shows top outbound destinations",
        "Link text/context captured for identification",
        "Works with target=_blank links"
      ],
      "files_to_modify": [
        "worker/src/track.js",
        "src/analytics_941/templates/partials/_events.html",
        "src/analytics_941/core/client.py"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added outbound click tracking to TRACKING_SCRIPT: isOutboundLink() checks if link host differs from current, getLinkText() extracts link text/alt/title (truncated to 50 chars), trackOutboundClick() fires event with destination/text/new_tab before navigation. For same-tab links, uses 100ms delay to ensure beacon fires. Added get_outbound_clicks() client method using json_extract on event_data. Added Top Outbound Links table to events template."
    },
    {
      "id": "track-3",
      "title": "Auto-track file downloads",
      "description": "Automatically track downloads of common file types (PDF, ZIP, etc.).",
      "acceptance_criteria": [
        "Downloads tracked for: pdf, zip, doc, xls, ppt, csv, txt, mp3, mp4",
        "Event includes filename and file type",
        "Works for both same-origin and cross-origin files",
        "Dashboard shows top downloaded files",
        "File extension configurable via data attribute"
      ],
      "files_to_modify": [
        "worker/src/track.js",
        "src/analytics_941/templates/partials/_events.html"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added file download tracking to TRACKING_SCRIPT: DOWNLOAD_EXTENSIONS array with 20+ extensions (pdf, zip, doc, docx, xls, xlsx, ppt, pptx, csv, txt, mp3, mp4, etc), configurable via data-download-extensions attribute. Functions: isDownloadLink() checks file extension against list, getFilename() extracts filename from URL, getFileExtension() gets extension. trackDownloadClick() fires event with filename/extension/url/external flag. Added get_file_downloads() client method using json_extract. Added File Downloads table to events template with file type icons."
    },
    {
      "id": "track-4",
      "title": "Auto-track form submissions",
      "description": "Automatically track form submissions with form identification.",
      "acceptance_criteria": [
        "Form submit events captured with form id/name/action",
        "No form data content captured (privacy)",
        "Success/failure status if detectable",
        "Dashboard shows form conversion rates",
        "Works with HTMX form submissions",
        "Excludes search forms by default"
      ],
      "files_to_modify": [
        "worker/src/track.js",
        "src/analytics_941/templates/partials/_events.html"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added form submission tracking to TRACKING_SCRIPT: isSearchForm() checks role=search and name/id/action containing 'search', getFormIdentifier() returns id/name/data-form-name, getFormAction() strips query params for privacy, trackFormSubmission() captures form_id/form_name/action/method/field_count/source. Listens to native submit events and htmx:beforeRequest for HTMX forms. Added get_form_submissions() client method. Added Form Submissions table to events template showing form id, action, method, submission count."
    },
    {
      "id": "track-5",
      "title": "JavaScript error tracking",
      "description": "Capture JavaScript errors to identify broken functionality.",
      "acceptance_criteria": [
        "window.onerror captured with message, source, line, column",
        "Unhandled promise rejections captured",
        "Stack trace included (truncated for size)",
        "Dashboard shows error count and top errors",
        "Errors grouped by message similarity",
        "Rate limited to prevent flood on broken page"
      ],
      "files_to_modify": [
        "worker/src/track.js",
        "src/analytics_941/templates/partials/_events.html"
      ],
      "priority": 3,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added JS error tracking to TRACKING_SCRIPT: rate limited to 10 errors per page load (resets every 60s), truncateStack() limits stack traces to 500 chars, normalizeErrorMessage() removes variable parts for grouping. Captures window.onerror with message/source/lineno/colno/stack, and unhandledrejection events for promise errors. Added get_js_errors() client method grouping by normalized message. Added JavaScript Errors table to events template with red error styling."
    },
    {
      "id": "track-6",
      "title": "Custom event API",
      "description": "Provide a simple JavaScript API for tracking custom events from application code.",
      "acceptance_criteria": [
        "window.analytics.track(name, properties) available",
        "Properties object serialized to JSON",
        "Events batched with pageviews (not separate requests)",
        "TypeScript types available for IDE support",
        "Example usage documented in README",
        "Works before/after DOMContentLoaded"
      ],
      "files_to_modify": [
        "worker/src/track.js",
        "README.md"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added public API to TRACKING_SCRIPT: window.analytics and window._941analytics expose track(eventName, properties), page(url, title), getSessionId(), identify(userId). Events use trackEvent() with type 'custom'. Queue processing via window._941q allows events before script loads - queue processed on init, then push() calls API directly. Created types/analytics.d.ts with full TypeScript definitions and JSDoc comments. Updated README.md with Custom Events section including basic usage, API methods, queue example, TypeScript reference, and auto-tracked events table."
    },
    {
      "id": "track-7",
      "title": "Events dashboard improvements",
      "description": "Complete the events dashboard with proper visualizations and filtering.",
      "acceptance_criteria": [
        "Event type breakdown chart (pie/bar)",
        "Events over time chart",
        "Top events table with count and trend",
        "Event properties drill-down",
        "Filter by event type",
        "Export events to CSV"
      ],
      "files_to_modify": [
        "src/analytics_941/templates/partials/_events.html",
        "src/analytics_941/routes/dashboard.py",
        "src/analytics_941/core/client.py"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added 3 new client methods: get_events_time_series() for daily event counts, get_events_with_trend() for top events with trend comparison to previous period, get_event_properties() for property breakdowns. Updated dashboard routes to fetch and pass new data including events_time_series, event_properties, selected_event, selected_event_type. Rewrote events_content.html with: active filters display with clear option, CSV export button, Events Over Time bar chart, Top Events table with trend column (up/down indicators and percentages), Event Type Breakdown horizontal bar chart, Event Properties drill-down section for selected event. All 105 tests pass."
    }
  ]
}
