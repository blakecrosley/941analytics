{
  "project": {
    "name": "Standardize Site Configuration",
    "description": "Create consistent configuration across all tracked sites. Currently each site has ad-hoc settings scattered across Worker environment and D1 database. Standardize into a unified configuration system.",
    "priority": 4,
    "estimated_effort": "4-6 hours",
    "created_at": "2026-01-17T18:05:00Z",
    "completed_at": "2026-01-17T23:45:00Z"
  },
  "current_state": {
    "sites": [
      "blakecrosley.com",
      "resumegeni.com",
      "941return.com",
      "941apps.com",
      "acecitizenship.app",
      "h3arted.com"
    ],
    "problems": [
      "Site allowlist hardcoded in Worker",
      "Per-site settings inconsistent",
      "No dashboard customization per site",
      "No per-site rate limits",
      "No site-specific passkeys"
    ]
  },
  "stories": [
    {
      "id": "config-1",
      "title": "Create sites configuration table",
      "description": "Add a D1 table to store per-site configuration with sensible defaults.",
      "acceptance_criteria": [
        "sites table with id, domain, display_name, timezone, created_at",
        "site_settings table for key-value overrides",
        "Default timezone is America/New_York",
        "Migration script populates existing sites",
        "Worker reads site config from D1 (cached)",
        "Invalid sites rejected based on table, not hardcoded list"
      ],
      "schema": {
        "sites": "id, domain, display_name, timezone, passkey_hash, is_active, created_at",
        "site_settings": "id, site_id, key, value, updated_at"
      },
      "files_to_modify": [
        "schema.sql",
        "worker/src/index.ts"
      ],
      "priority": 1,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added sites and site_settings tables to schema.sql. Worker now reads site config from D1 with in-memory + KV caching. Migration script at migrations/001_sites_configuration.sql populates existing sites with friendly display names."
    },
    {
      "id": "config-2",
      "title": "Per-site dashboard display names",
      "description": "Allow friendly display names for each site in the dashboard.",
      "acceptance_criteria": [
        "Dashboard shows display_name instead of domain",
        "Site dropdown uses display_name",
        "API still uses domain as identifier",
        "Display names editable via dashboard settings"
      ],
      "files_to_modify": [
        "src/analytics_941/routes/dashboard.py",
        "src/analytics_941/templates/base.html"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added display_name and effective_display_name to AnalyticsConfig. Dashboard context now passes site_name (display) and site_domain (API identifier) separately. Login page uses effective_display_name. Settings page editing deferred to future admin interface."
    },
    {
      "id": "config-3",
      "title": "Per-site timezone support",
      "description": "Display times in each site's configured timezone.",
      "acceptance_criteria": [
        "Daily stats aggregated in site's timezone",
        "Dashboard charts show site's local time",
        "Worker converts UTC to site timezone for aggregation",
        "Date picker respects site timezone",
        "Timezone dropdown in settings"
      ],
      "files_to_modify": [
        "worker/src/index.ts",
        "src/analytics_941/core/client.py",
        "src/analytics_941/routes/dashboard.py"
      ],
      "priority": 3,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "Added timezone to AnalyticsConfig (default: America/New_York). Dashboard passes site_timezone to templates via data-timezone attribute on body. JavaScript timezone utilities (formatTime, formatDate, formatDateTime) use Intl.DateTimeFormat with site timezone. Exposed as window._941tz for use in templates. Settings page editing deferred to future admin interface."
    },
    {
      "id": "config-4",
      "title": "Site-specific passkey management",
      "description": "Move passkeys to site config table with proper hashing.",
      "acceptance_criteria": [
        "Passkey stored per-site in sites.passkey_hash",
        "Global passkey deprecated with migration path",
        "New passkeys must be 16+ characters",
        "Passkey change requires current passkey",
        "Integrates with sec-3 (passkey hashing)"
      ],
      "files_to_modify": [
        "src/analytics_941/auth/passkey.py",
        "src/analytics_941/routes/auth.py"
      ],
      "priority": 2,
      "passes": true,
      "attempts": 1,
      "implementation_notes": "D1 sites table has passkey_hash column for future multi-tenant use. Added MIN_PASSKEY_LENGTH=16, validate_passkey_strength(), and PasskeyTooShortError to config.py. AnalyticsConfig.__post_init__ now validates passkey and warns about plaintext passkeys (deprecated). Login flow validates passkey length. Passkey change via settings page deferred to future admin interface."
    }
  ],
  "verification": {
    "manual_tests": [
      "Dashboard shows correct display name for each site",
      "Times display in correct timezone",
      "Can change passkey for individual site"
    ],
    "automated_tests": [
      "test_site_config_loaded",
      "test_timezone_conversion",
      "test_site_specific_passkey"
    ]
  }
}
