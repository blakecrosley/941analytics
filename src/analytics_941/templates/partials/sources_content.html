{# Sources tab content - traffic source breakdown #}
{# Layout: Primary (controls + KPIs) ‚Üí Secondary (sources breakdown) #}

{# ===== PRIMARY ZONE: Controls & KPIs ===== #}
<div class="analytics-zone-primary">
    {% include "components/date_picker.html" %}

    {% include "components/stats_cards.html" %}
</div>

{# ===== SECONDARY ZONE: Sources Breakdown ===== #}
<div class="analytics-zone-secondary">
<div class="analytics-grid-2">
    {# All Sources #}
    <div class="analytics-section">
        <div class="analytics-section__header">
            <span class="analytics-section__title">All Sources</span>
            <div class="analytics-section__actions">
                {% with export_type="sources" %}{% include "components/export_button.html" %}{% endwith %}
            </div>
        </div>
        <div class="analytics-section__content analytics-section__content--flush">
            {% if sources|length > 0 %}
            {% set max_visits = sources|map(attribute='visits')|max %}
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th class="analytics-text-right">Visits</th>
                        <th class="analytics-text-right">Visitors</th>
                        <th class="analytics-text-right">Bounce</th>
                    </tr>
                </thead>
                <tbody>
                    {% for source in sources[:20] %}
                    <tr>
                        <td>
                            <a href="?source={{ source.source|urlencode }}"
                               hx-get="./partials/sources?source={{ source.source|urlencode }}"
                               hx-target="#main-content"
                               hx-push-url="?source={{ source.source|urlencode }}"
                               style="text-decoration: none; color: var(--941-color-text-muted);">
                                {{ source.source or 'Direct' }}
                            </a>
                            <span class="analytics-text-muted" style="font-size: 0.75rem; margin-left: 0.5rem;">{{ source.source_type }}</span>
                            <div class="analytics-table__bar">
                                <div class="analytics-table__bar-fill" style="width: {{ (source.visits / max_visits * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="analytics-text-right analytics-table__number">{{ "{:,}".format(source.visits) }}</td>
                        <td class="analytics-text-right analytics-table__number">{{ "{:,}".format(source.visitors) }}</td>
                        <td class="analytics-text-right analytics-table__number">{{ "{:.0f}".format(source.bounce_rate or 0) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="analytics-empty">
                <div class="analytics-empty__icon">üîó</div>
                <p>No source data for this period</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# Source Types #}
    <div class="analytics-section">
        <div class="analytics-section__header">
            <span class="analytics-section__title">Source Types</span>
        </div>
        <div class="analytics-section__content analytics-section__content--flush">
            {% if source_types|length > 0 %}
            {% set max_type_visits = source_types|map(attribute='visits')|max %}
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th class="analytics-text-right">Visits</th>
                        <th class="analytics-text-right">%</th>
                    </tr>
                </thead>
                <tbody>
                    {% set total_visits = source_types|map(attribute='visits')|sum %}
                    {% for stype in source_types %}
                    <tr>
                        <td>
                            <a href="?source_type={{ stype.source_type }}"
                               hx-get="./partials/sources?source_type={{ stype.source_type }}"
                               hx-target="#main-content"
                               hx-push-url="?source_type={{ stype.source_type }}"
                               style="text-decoration: none; color: var(--941-color-text-muted);">
                                {% if stype.source_type == 'direct' %}üéØ
                                {% elif stype.source_type == 'organic' %}üîç
                                {% elif stype.source_type == 'social' %}üì±
                                {% elif stype.source_type == 'referral' %}üîó
                                {% elif stype.source_type == 'email' %}üìß
                                {% else %}üåê{% endif %}
                                {{ stype.source_type|capitalize }}
                            </a>
                            <div class="analytics-table__bar">
                                <div class="analytics-table__bar-fill" style="width: {{ (stype.visits / max_type_visits * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="analytics-text-right analytics-table__number">{{ "{:,}".format(stype.visits) }}</td>
                        <td class="analytics-text-right analytics-table__number">{{ "{:.1f}".format(stype.visits / total_visits * 100) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="analytics-empty">
                <div class="analytics-empty__icon">üìä</div>
                <p>No source type data</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="analytics-grid-2">
    {# UTM Sources #}
    <div class="analytics-section">
        <div class="analytics-section__header">
            <span class="analytics-section__title">UTM Sources</span>
        </div>
        <div class="analytics-section__content analytics-section__content--flush">
            {% if utm_sources|length > 0 %}
            {% set max_utm = utm_sources|map(attribute='visits')|max %}
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>utm_source</th>
                        <th class="analytics-text-right">Visits</th>
                    </tr>
                </thead>
                <tbody>
                    {% for utm in utm_sources[:10] %}
                    <tr>
                        <td>
                            <a href="?utm_source={{ utm.utm_source|urlencode }}"
                               hx-get="./partials/sources?utm_source={{ utm.utm_source|urlencode }}"
                               hx-target="#main-content"
                               hx-push-url="?utm_source={{ utm.utm_source|urlencode }}"
                               style="text-decoration: none; color: var(--941-color-text-muted);">
                                {{ utm.utm_source }}
                            </a>
                            <div class="analytics-table__bar">
                                <div class="analytics-table__bar-fill" style="width: {{ (utm.visits / max_utm * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="analytics-text-right analytics-table__number">{{ "{:,}".format(utm.visits) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="analytics-empty">
                <div class="analytics-empty__icon">üè∑Ô∏è</div>
                <p>No UTM sources</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# UTM Campaigns #}
    <div class="analytics-section">
        <div class="analytics-section__header">
            <span class="analytics-section__title">UTM Campaigns</span>
        </div>
        <div class="analytics-section__content analytics-section__content--flush">
            {% if utm_campaigns|length > 0 %}
            {% set max_campaign = utm_campaigns|map(attribute='visits')|max %}
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>utm_campaign</th>
                        <th class="analytics-text-right">Visits</th>
                    </tr>
                </thead>
                <tbody>
                    {% for campaign in utm_campaigns[:10] %}
                    <tr>
                        <td>
                            <a href="?utm_campaign={{ campaign.utm_campaign|urlencode }}"
                               hx-get="./partials/sources?utm_campaign={{ campaign.utm_campaign|urlencode }}"
                               hx-target="#main-content"
                               hx-push-url="?utm_campaign={{ campaign.utm_campaign|urlencode }}"
                               style="text-decoration: none; color: var(--941-color-text-muted);">
                                {{ campaign.utm_campaign }}
                            </a>
                            <div class="analytics-table__bar">
                                <div class="analytics-table__bar-fill" style="width: {{ (campaign.visits / max_campaign * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="analytics-text-right analytics-table__number">{{ "{:,}".format(campaign.visits) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="analytics-empty">
                <div class="analytics-empty__icon">üì£</div>
                <p>No UTM campaigns</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
</div>{# End analytics-zone-secondary #}
