{# Geography tab content - country/region breakdown with lazy-loaded globe #}

{% include "components/date_picker.html" %}

{% include "components/stats_cards.html" %}

{# Lazy-loaded 3D Globe #}
{% if config.enable_globe %}
<div class="section">
    <div class="section__header">
        <span class="section__title">Visitor Globe</span>
        <button class="btn btn--small" onclick="loadGlobe()">Load 3D Globe</button>
    </div>
    <div class="section__content">
        <div id="globe-container" style="width: 100%; height: 400px; display: flex; align-items: center; justify-content: center;">
            <span class="text-muted">Click "Load 3D Globe" to view interactive visualization</span>
        </div>
        <script type="application/json" id="globe-data">{{ globe_data|tojson|safe }}</script>
    </div>
</div>
{# Globe script inline to work with both full page and HTMX partial loads #}
<script>
    // Lazy load Three.js globe when user clicks "Load Globe"
    function loadGlobe() {
        const container = document.getElementById('globe-container');
        if (!container || container.dataset.loaded === 'true') return;

        // Clear container safely and show loading
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.textContent = 'Loading 3D globe...';
        container.appendChild(loadingDiv);
        container.dataset.loaded = 'true';

        // Dynamically load Three.js (r125 - last version with standalone OrbitControls.js)
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/three@0.125.0/build/three.min.js';
        script.onload = function() {
            // Load OrbitControls after Three.js
            const controls = document.createElement('script');
            controls.src = 'https://unpkg.com/three@0.125.0/examples/js/controls/OrbitControls.js';
            controls.onload = initGlobe;
            document.head.appendChild(controls);
        };
        document.head.appendChild(script);
    }

    function initGlobe() {
        const container = document.getElementById('globe-container');
        const data = JSON.parse(document.getElementById('globe-data').textContent);

        const width = container.clientWidth;
        const height = 400;

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
        camera.position.z = 2.5;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(width, height);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        // Clear container safely and add canvas
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        container.appendChild(renderer.domElement);

        // Earth sphere
        const geometry = new THREE.SphereGeometry(1, 64, 64);
        const material = new THREE.MeshBasicMaterial({
            color: 0x1a1a1a,
            wireframe: true,
            transparent: true,
            opacity: 0.3
        });
        const earth = new THREE.Mesh(geometry, material);
        scene.add(earth);

        // Add points for countries
        data.countries.forEach(function(country) {
            if (!country.lat || !country.lon) return;

            const phi = (90 - country.lat) * (Math.PI / 180);
            const theta = (country.lon + 180) * (Math.PI / 180);

            const x = -Math.sin(phi) * Math.cos(theta);
            const y = Math.cos(phi);
            const z = Math.sin(phi) * Math.sin(theta);

            const size = Math.min(0.05, Math.max(0.02, country.visits / 100 * 0.02));
            const pointGeometry = new THREE.SphereGeometry(size, 8, 8);
            const pointMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const point = new THREE.Mesh(pointGeometry, pointMaterial);
            point.position.set(x * 1.02, y * 1.02, z * 1.02);
            scene.add(point);
        });

        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = false;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle resize
        window.addEventListener('resize', function() {
            const newWidth = container.clientWidth;
            camera.aspect = newWidth / height;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, height);
        });
    }
</script>
{% endif %}

<div class="grid-2">
    {# Countries #}
    <div class="section">
        <div class="section__header">
            <span class="section__title">Countries</span>
        </div>
        <div class="section__content section__content--flush">
            {% if countries|length > 0 %}
            {% set max_visits = countries|map(attribute='visits')|max %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th class="text-right">Visits</th>
                        <th class="text-right">Visitors</th>
                    </tr>
                </thead>
                <tbody>
                    {% for country in countries[:20] %}
                    <tr>
                        <td>
                            <a href="?country={{ country.country_code }}"
                               hx-get="./partials/geography?country={{ country.country_code }}"
                               hx-target="#main-content"
                               hx-push-url="?country={{ country.country_code }}"
                               style="text-decoration: none; color: var(--muted);">
                                {{ country.country_name }}
                            </a>
                            <div class="table__bar">
                                <div class="table__bar-fill" style="width: {{ (country.visits / max_visits * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="text-right table__number">{{ "{:,}".format(country.visits) }}</td>
                        <td class="text-right table__number">{{ "{:,}".format(country.visitors) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty">
                <div class="empty__icon">üåç</div>
                <p>No geographic data for this period</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# Regions (if country filter is active) #}
    {% if filters.country and regions|length > 0 %}
    <div class="section">
        <div class="section__header">
            <span class="section__title">Regions in {{ filters.country }}</span>
        </div>
        <div class="section__content section__content--flush">
            {% set max_region_visits = regions|map(attribute='visits')|max %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Region</th>
                        <th class="text-right">Visits</th>
                    </tr>
                </thead>
                <tbody>
                    {% for region in regions[:15] %}
                    <tr>
                        <td>
                            <a href="?country={{ filters.country }}&region={{ region.region|urlencode }}"
                               hx-get="./partials/geography?country={{ filters.country }}&region={{ region.region|urlencode }}"
                               hx-target="#main-content"
                               hx-push-url="?country={{ filters.country }}&region={{ region.region|urlencode }}"
                               style="text-decoration: none; color: var(--muted);">
                                {{ region.region or '(Unknown)' }}
                            </a>
                            <div class="table__bar">
                                <div class="table__bar-fill" style="width: {{ (region.visits / max_region_visits * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="text-right table__number">{{ "{:,}".format(region.visits) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% elif not filters.country %}
    {# Show map placeholder or world regions summary when no country selected #}
    <div class="section">
        <div class="section__header">
            <span class="section__title">Regions</span>
        </div>
        <div class="section__content">
            <div class="empty">
                <div class="empty__icon">üó∫Ô∏è</div>
                <p>Select a country to view regions</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{# Cities (if region filter is active) #}
{% if filters.region and cities|length > 0 %}
<div class="section">
    <div class="section__header">
        <span class="section__title">Cities in {{ filters.region }}, {{ filters.country }}</span>
    </div>
    <div class="section__content section__content--flush">
        {% set max_city_visits = cities|map(attribute='visits')|max %}
        <table class="table">
            <thead>
                <tr>
                    <th>City</th>
                    <th class="text-right">Visits</th>
                </tr>
            </thead>
            <tbody>
                {% for city in cities[:20] %}
                <tr>
                    <td>
                        {{ city.city or '(Unknown)' }}
                        <div class="table__bar">
                            <div class="table__bar-fill" style="width: {{ (city.visits / max_city_visits * 100)|int }}%;"></div>
                        </div>
                    </td>
                    <td class="text-right table__number">{{ "{:,}".format(city.visits) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
