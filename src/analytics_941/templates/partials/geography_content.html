{# Geography tab content - country/region breakdown with lazy-loaded globe #}

{% include "components/date_picker.html" %}

{% include "components/stats_cards.html" %}

{# Lazy-loaded 3D Globe #}
{% if config.enable_globe %}
<div class="section">
    <div class="section__header">
        <span class="section__title">Visitor Globe</span>
        <button class="btn btn--small" onclick="loadGlobe()">Load 3D Globe</button>
    </div>
    <div class="section__content">
        <div id="globe-container" style="width: 100%; height: 400px; display: flex; align-items: center; justify-content: center;">
            <span class="text-muted">Click "Load 3D Globe" to view interactive visualization</span>
        </div>
        <script type="application/json" id="globe-data">{{ globe_data|tojson|safe }}</script>
    </div>
</div>
{# Globe script inline to work with both full page and HTMX partial loads #}
<script>
    // Globe state management for cleanup (globe-1: memory management)
    window._941globe = window._941globe || {
        animationId: null,
        renderer: null,
        scene: null,
        resizeHandler: null,
        cleanup: function() {
            // Stop animation loop
            if (this.animationId) {
                cancelAnimationFrame(this.animationId);
                this.animationId = null;
            }
            // Dispose of WebGL resources
            if (this.renderer) {
                this.renderer.dispose();
                this.renderer = null;
            }
            // Clear scene
            if (this.scene) {
                this.scene.traverse(function(object) {
                    if (object.geometry) object.geometry.dispose();
                    if (object.material) object.material.dispose();
                });
                this.scene = null;
            }
            // Remove resize listener
            if (this.resizeHandler) {
                window.removeEventListener('resize', this.resizeHandler);
                this.resizeHandler = null;
            }
        }
    };

    // Check if device should show 2D instead of 3D (globe-3: device detection)
    function shouldUse2DMap() {
        // Check user preference first
        const pref = localStorage.getItem('globe_preference');
        if (pref === '2d') return true;
        if (pref === '3d') return false;

        // Auto-detect: mobile, low memory, or prefers-reduced-motion
        const isMobile = /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const lowMemory = navigator.deviceMemory && navigator.deviceMemory < 4;
        const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        return isMobile || lowMemory || reducedMotion;
    }

    // Lazy load Three.js globe when user clicks "Load Globe"
    function loadGlobe() {
        const container = document.getElementById('globe-container');
        if (!container || container.dataset.loaded === 'true') return;

        // Check if we should show 2D instead
        if (shouldUse2DMap()) {
            show2DFallback(container);
            return;
        }

        // Cleanup any previous instance
        window._941globe.cleanup();

        // Clear container safely and show loading
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading';
        loadingDiv.textContent = 'Loading 3D globe...';
        container.appendChild(loadingDiv);
        container.dataset.loaded = 'true';

        // Check if Three.js is already loaded
        if (window.THREE) {
            initGlobe();
            return;
        }

        // Dynamically load Three.js (r125 - last version with standalone OrbitControls.js)
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/three@0.125.0/build/three.min.js';
        script.onload = function() {
            // Load OrbitControls after Three.js
            const controls = document.createElement('script');
            controls.src = 'https://unpkg.com/three@0.125.0/examples/js/controls/OrbitControls.js';
            controls.onload = initGlobe;
            document.head.appendChild(controls);
        };
        document.head.appendChild(script);
    }

    // 2D fallback for mobile/low-power devices (globe-3)
    function show2DFallback(container) {
        container.dataset.loaded = 'true';
        const data = JSON.parse(document.getElementById('globe-data').textContent);

        // Clear container using safe DOM methods
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        // Create wrapper
        const wrapper = document.createElement('div');
        wrapper.style.cssText = 'padding: 1rem; text-align: center;';

        // Info text
        const info = document.createElement('p');
        info.style.cssText = 'color: var(--muted); margin-bottom: 1rem;';
        info.textContent = 'Showing simplified view for better performance. ';

        // Toggle button
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn--small';
        toggleBtn.style.marginLeft = '0.5rem';
        toggleBtn.textContent = 'Try 3D';
        toggleBtn.onclick = toggle3DGlobe;
        info.appendChild(toggleBtn);

        wrapper.appendChild(info);

        // Country chips container
        const chipContainer = document.createElement('div');
        chipContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;';

        // Add country chips (safe DOM creation, no innerHTML)
        data.countries.slice(0, 10).forEach(function(c) {
            const chip = document.createElement('span');
            chip.style.cssText = 'background: var(--surface); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;';
            chip.textContent = c.country_name + ': ' + c.visits.toLocaleString();
            chipContainer.appendChild(chip);
        });

        wrapper.appendChild(chipContainer);
        container.appendChild(wrapper);
    }

    // Toggle between 2D and 3D
    function toggle3DGlobe() {
        localStorage.setItem('globe_preference', '3d');
        const container = document.getElementById('globe-container');
        container.dataset.loaded = 'false';
        loadGlobe();
    }

    function initGlobe() {
        const container = document.getElementById('globe-container');
        const data = JSON.parse(document.getElementById('globe-data').textContent);

        const width = container.clientWidth;
        const height = 400;

        const scene = new THREE.Scene();
        window._941globe.scene = scene;

        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
        camera.position.z = 2.5;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(width, height);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        window._941globe.renderer = renderer;

        // Clear container safely and add canvas
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        container.appendChild(renderer.domElement);

        // Add toggle button using safe DOM methods
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn--small';
        toggleBtn.style.cssText = 'position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10;';
        toggleBtn.textContent = 'Use 2D';
        toggleBtn.onclick = function() {
            localStorage.setItem('globe_preference', '2d');
            window._941globe.cleanup();
            container.dataset.loaded = 'false';
            loadGlobe();
        };
        container.style.position = 'relative';
        container.appendChild(toggleBtn);

        // Earth sphere
        const geometry = new THREE.SphereGeometry(1, 64, 64);
        const material = new THREE.MeshBasicMaterial({
            color: 0x1a1a1a,
            wireframe: true,
            transparent: true,
            opacity: 0.3
        });
        const earth = new THREE.Mesh(geometry, material);
        scene.add(earth);

        // Add points for countries
        data.countries.forEach(function(country) {
            if (!country.lat || !country.lon) return;

            const phi = (90 - country.lat) * (Math.PI / 180);
            const theta = (country.lon + 180) * (Math.PI / 180);

            const x = -Math.sin(phi) * Math.cos(theta);
            const y = Math.cos(phi);
            const z = Math.sin(phi) * Math.sin(theta);

            const size = Math.min(0.05, Math.max(0.02, country.visits / 100 * 0.02));
            const pointGeometry = new THREE.SphereGeometry(size, 8, 8);
            const pointMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const point = new THREE.Mesh(pointGeometry, pointMaterial);
            point.position.set(x * 1.02, y * 1.02, z * 1.02);
            scene.add(point);
        });

        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = false;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        function animate() {
            window._941globe.animationId = requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle resize
        window._941globe.resizeHandler = function() {
            const newWidth = container.clientWidth;
            camera.aspect = newWidth / height;
            camera.updateProjectionMatrix();
            renderer.setSize(newWidth, height);
        };
        window.addEventListener('resize', window._941globe.resizeHandler);
    }

    // Cleanup when navigating away (HTMX integration for globe-1)
    document.addEventListener('htmx:beforeSwap', function(event) {
        // Only cleanup if leaving geography tab
        if (event.detail.target && event.detail.target.id === 'main-content') {
            window._941globe.cleanup();
        }
    });
</script>
{% endif %}

<div class="grid-2">
    {# Countries #}
    <div class="section">
        <div class="section__header">
            <span class="section__title">Countries</span>
        </div>
        <div class="section__content section__content--flush">
            {% if countries|length > 0 %}
            {% set max_visits = countries|map(attribute='visits')|max %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th class="text-right">Visits</th>
                        <th class="text-right">Visitors</th>
                    </tr>
                </thead>
                <tbody>
                    {% for country in countries[:20] %}
                    <tr>
                        <td>
                            <a href="?country={{ country.country_code }}"
                               hx-get="./partials/geography?country={{ country.country_code }}"
                               hx-target="#main-content"
                               hx-push-url="?country={{ country.country_code }}"
                               style="text-decoration: none; color: var(--muted);">
                                {{ country.country_name }}
                            </a>
                            <div class="table__bar">
                                <div class="table__bar-fill" style="width: {{ (country.visits / max_visits * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="text-right table__number">{{ "{:,}".format(country.visits) }}</td>
                        <td class="text-right table__number">{{ "{:,}".format(country.visitors) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty">
                <div class="empty__icon">üåç</div>
                <p>No geographic data for this period</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# Regions (if country filter is active) #}
    {% if filters.country and regions|length > 0 %}
    <div class="section">
        <div class="section__header">
            <span class="section__title">Regions in {{ filters.country }}</span>
        </div>
        <div class="section__content section__content--flush">
            {% set max_region_visits = regions|map(attribute='visits')|max %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Region</th>
                        <th class="text-right">Visits</th>
                    </tr>
                </thead>
                <tbody>
                    {% for region in regions[:15] %}
                    <tr>
                        <td>
                            <a href="?country={{ filters.country }}&region={{ region.region|urlencode }}"
                               hx-get="./partials/geography?country={{ filters.country }}&region={{ region.region|urlencode }}"
                               hx-target="#main-content"
                               hx-push-url="?country={{ filters.country }}&region={{ region.region|urlencode }}"
                               style="text-decoration: none; color: var(--muted);">
                                {{ region.region or '(Unknown)' }}
                            </a>
                            <div class="table__bar">
                                <div class="table__bar-fill" style="width: {{ (region.visits / max_region_visits * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="text-right table__number">{{ "{:,}".format(region.visits) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% elif not filters.country %}
    {# Show map placeholder or world regions summary when no country selected #}
    <div class="section">
        <div class="section__header">
            <span class="section__title">Regions</span>
        </div>
        <div class="section__content">
            <div class="empty">
                <div class="empty__icon">üó∫Ô∏è</div>
                <p>Select a country to view regions</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{# Cities (if region filter is active) #}
{% if filters.region and cities|length > 0 %}
<div class="section">
    <div class="section__header">
        <span class="section__title">Cities in {{ filters.region }}, {{ filters.country }}</span>
    </div>
    <div class="section__content section__content--flush">
        {% set max_city_visits = cities|map(attribute='visits')|max %}
        <table class="table">
            <thead>
                <tr>
                    <th>City</th>
                    <th class="text-right">Visits</th>
                </tr>
            </thead>
            <tbody>
                {% for city in cities[:20] %}
                <tr>
                    <td>
                        {{ city.city or '(Unknown)' }}
                        <div class="table__bar">
                            <div class="table__bar-fill" style="width: {{ (city.visits / max_city_visits * 100)|int }}%;"></div>
                        </div>
                    </td>
                    <td class="text-right table__number">{{ "{:,}".format(city.visits) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
