{# Realtime tab content - live visitors #}
{# Layout: Primary (live count + activity feed) ‚Üí Secondary (breakdowns) #}

{# ===== PRIMARY ZONE: Live Activity Feed ===== #}
<div class="analytics-zone-primary"
     x-data="activityFeedComponent()"
     x-init="startPolling()">
    <div class="analytics-grid-2">
        {# Live Visitor Count Card #}
        <div class="analytics-stat-card analytics-stat-card--hero analytics-stat-card--live">
            <div class="analytics-stat-card__label">
                <span class="analytics-live"><span class="analytics-live__dot"></span></span>
                Active Visitors
            </div>
            <div class="analytics-stat-card__value">{{ realtime.active_visitors }}</div>
            <div class="analytics-stat-card__period">in the last 5 minutes</div>
        </div>

        {# Activity Feed Section #}
        <div class="analytics-section analytics-section--activity">
            <div class="analytics-section__header">
                <span class="analytics-section__title">Live Activity</span>
                <div class="analytics-activity-controls">
                    {# Event type filter #}
                    <select class="analytics-activity-filter"
                            x-model="eventTypeFilter"
                            @change="refresh()"
                            aria-label="Filter by event type">
                        <option value="all">All events</option>
                        <option value="pageview">Pageviews</option>
                    </select>
                    {# Pause/Resume toggle #}
                    <button class="analytics-btn analytics-btn--small analytics-btn--icon"
                            @click="togglePause()"
                            :title="paused ? 'Resume updates' : 'Pause updates'"
                            :aria-pressed="paused">
                        <template x-if="!paused">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>
                            </svg>
                        </template>
                        <template x-if="paused">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="5,3 19,12 5,21"/>
                            </svg>
                        </template>
                    </button>
                </div>
            </div>
            <div class="analytics-section__content analytics-section__content--flush"
                 id="activity-feed-container"
                 hx-get="./partials/activity-feed"
                 hx-trigger="every 5s"
                 hx-swap="innerHTML"
                 x-ref="feedContainer"
                 :hx-trigger="paused ? 'none' : 'every 5s'">
                {# Initial render uses realtime data #}
                {% set activity = realtime.recent_activity %}
                {% set active_count = realtime.active_visitors %}
                {% include "components/activity_feed.html" %}
            </div>
        </div>
    </div>
</div>

{# ===== SECONDARY ZONE: Active Breakdowns ===== #}
<div class="analytics-zone-secondary">
<div class="analytics-grid-2">
    {# Active Pages #}
    <div class="analytics-section">
        <div class="analytics-section__header">
            <span class="analytics-section__title">Active Pages</span>
        </div>
        <div class="analytics-section__content analytics-section__content--flush">
            {% if realtime.pages|length > 0 %}
            {% set max_page_count = realtime.pages|map(attribute='count')|max %}
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>Page</th>
                        <th class="analytics-text-right">Visitors</th>
                    </tr>
                </thead>
                <tbody>
                    {% for page in realtime.pages[:15] %}
                    <tr>
                        <td>
                            <span class="analytics-truncate" style="display: block; max-width: 350px;">{{ page.url }}</span>
                            <div class="analytics-table__bar">
                                <div class="analytics-table__bar-fill" style="width: {{ (page.count / max_page_count * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="analytics-text-right analytics-table__number">{{ page.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="analytics-empty">
                <div class="analytics-empty__icon">üìÑ</div>
                <p>No active pages</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# Active Sources #}
    <div class="analytics-section">
        <div class="analytics-section__header">
            <span class="analytics-section__title">Active Sources</span>
        </div>
        <div class="analytics-section__content analytics-section__content--flush">
            {% if realtime.sources|length > 0 %}
            {% set max_source_count = realtime.sources|map(attribute='count')|max %}
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th class="analytics-text-right">Visitors</th>
                    </tr>
                </thead>
                <tbody>
                    {% for source in realtime.sources[:10] %}
                    <tr>
                        <td>
                            {{ source.source or 'Direct' }}
                            <div class="analytics-table__bar">
                                <div class="analytics-table__bar-fill" style="width: {{ (source.count / max_source_count * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="analytics-text-right analytics-table__number">{{ source.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="analytics-empty">
                <div class="analytics-empty__icon">üîó</div>
                <p>No active sources</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="analytics-grid-2">
    {# Active Countries #}
    <div class="analytics-section">
        <div class="analytics-section__header">
            <span class="analytics-section__title">Active Countries</span>
        </div>
        <div class="analytics-section__content analytics-section__content--flush">
            {% if realtime.countries|length > 0 %}
            {% set max_country_count = realtime.countries|map(attribute='count')|max %}
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th class="analytics-text-right">Visitors</th>
                    </tr>
                </thead>
                <tbody>
                    {% for country in realtime.countries[:10] %}
                    <tr>
                        <td>
                            {{ country.name or country.code or 'Unknown' }}
                            <div class="analytics-table__bar">
                                <div class="analytics-table__bar-fill" style="width: {{ (country.count / max_country_count * 100)|int }}%;"></div>
                            </div>
                        </td>
                        <td class="analytics-text-right analytics-table__number">{{ country.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="analytics-empty">
                <div class="analytics-empty__icon">üåç</div>
                <p>No active visitors by country</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# Active Sessions (detailed view) #}
    <div class="analytics-section">
        <div class="analytics-section__header">
            <span class="analytics-section__title">Live Sessions</span>
        </div>
        <div class="analytics-section__content analytics-section__content--flush">
            {% if realtime.active_sessions|length > 0 %}
            <table class="analytics-table">
                <thead>
                    <tr>
                        <th>Page</th>
                        <th>Device</th>
                        <th>Country</th>
                        <th class="analytics-text-right">Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in realtime.active_sessions[:15] %}
                    <tr>
                        <td>
                            <span class="analytics-truncate" style="display: block; max-width: 200px; font-size: 0.8125rem;">{{ session.page }}</span>
                        </td>
                        <td style="font-size: 0.8125rem;">
                            {% if session.device == 'desktop' %}üíª{% elif session.device == 'mobile' %}üì±{% else %}üìü{% endif %}
                        </td>
                        <td style="font-size: 0.8125rem;">{{ session.country or 'üåê' }}</td>
                        <td class="analytics-text-right analytics-text-muted" style="font-size: 0.75rem;">
                            {{ session.started|timesince if session.started else 'now' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="analytics-empty">
                <div class="analytics-empty__icon">üë§</div>
                <p>No active sessions</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
</div>{# End analytics-zone-secondary #}
